# File Encryption System

This document describes the file encryption system implemented in the server application to secure user files.

## Overview

Files uploaded by users are encrypted with a simple AES-like algorithm developed specifically for educational purposes. Each user has a unique encryption key derived from their user ID and a master key stored in the server's environment variables.

## Implementation Details

### Key Management

- **Master Key**: A single master key is stored in the `.env` file as `MASTER_KEY`.
- **User Keys**: Each user has a unique encryption key derived from the master key and their user ID.
- **Key Derivation**: The user-specific key is generated by encrypting the user's ID with the master key.

### Encryption Process

1. When a file is uploaded:
   - The file is temporarily saved to disk by multer.
   - Before processing, the file is read from disk and encrypted using the user's key.
   - The encrypted version is written back to disk, replacing the unencrypted version.
   - The file's metadata is saved in the database, but the actual file content is stored encrypted.

2. When a file is viewed or downloaded:
   - The encrypted file is read from disk.
   - It's decrypted using the user's key.
   - A temporary decrypted version is created and streamed to the user.
   - The temporary decrypted file is deleted after streaming completes.

### AES Implementation

The simple AES implementation includes the following operations:

1. **Key Expansion**: Extends the key to the required block size.
2. **Substitution (SubBytes)**: Replaces each byte with another according to a simple transformation.
3. **Shifting (ShiftRows)**: Rearranges bytes within the data.
4. **Key Addition**: XORs the data with the key.

For decryption, these operations are reversed to recover the original data.

## Security Considerations

This implementation is for educational purposes only and follows the college requirement to implement encryption without external libraries. It is not intended for production use or securing sensitive information.

For a production environment, use established cryptography libraries and follow security best practices.

## File Locations

- **AES Implementation**: `src/utils/simpleAes.utils.ts`
- **Crypto Utilities**: `src/utils/cryptoUtil.utils.ts`
- **Encryption Middleware**: `src/middleware/fileEncryption.middleware.ts`

## Testing

You can test the encryption system by:

1. Uploading a file through the API
2. Verifying that the file stored on disk is encrypted (appears as random bytes)
3. Downloading or viewing the file through the API to confirm it's correctly decrypted
